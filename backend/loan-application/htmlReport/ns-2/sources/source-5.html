


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RepaymentScheduleServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">tech.zetapioneers.loan_application.concreteservice</a>
</div>

<h1>Coverage Summary for Class: RepaymentScheduleServiceImpl (tech.zetapioneers.loan_application.concreteservice)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RepaymentScheduleServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package tech.zetapioneers.loan_application.concreteservice;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import tech.zetapioneers.loan_application.dto.EmiPreviewRequest;
&nbsp;import tech.zetapioneers.loan_application.dto.EmiPreviewResponse;
&nbsp;import tech.zetapioneers.loan_application.dto.RepaymentScheduleDTO;
&nbsp;import tech.zetapioneers.loan_application.entities.LoanApplication;
&nbsp;import tech.zetapioneers.loan_application.entities.RepaymentSchedule;
&nbsp;import tech.zetapioneers.loan_application.repositories.RepaymentScheduleRepository;
&nbsp;import tech.zetapioneers.loan_application.services.RepaymentScheduleService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class RepaymentScheduleServiceImpl implements RepaymentScheduleService {
&nbsp;
&nbsp;    private final RepaymentScheduleRepository repaymentScheduleRepository;
&nbsp;
&nbsp;    @Override
&nbsp;    public double calculateEMI(double principal, double annualRate, int months) {
<b class="nc">&nbsp;        double monthlyRate = annualRate / 12 / 100; // Convert annual % to monthly decimal</b>
<b class="nc">&nbsp;        return (principal * monthlyRate * Math.pow(1 + monthlyRate, months)) /</b>
<b class="nc">&nbsp;                (Math.pow(1 + monthlyRate, months) - 1);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;RepaymentSchedule&gt; generateSchedule(LoanApplication loan) {
&nbsp;        // pull the rate from LoanType enum
<b class="nc">&nbsp;        System.out.println(loan);</b>
<b class="nc">&nbsp;        double annualRate = loan.getLoanType().getInterestRate();</b>
&nbsp;
<b class="nc">&nbsp;        double principal = loan.getAmount();</b>
<b class="nc">&nbsp;        int months = loan.getTenureMonths();</b>
<b class="nc">&nbsp;        double emi = calculateEMI(principal, annualRate, months);</b>
<b class="nc">&nbsp;        double monthlyRate = annualRate / 12 / 100;</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;RepaymentSchedule&gt; schedules = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        double balance = principal;</b>
&nbsp;
<b class="nc">&nbsp;        for (int m = 1; m &lt;= months; m++) {</b>
<b class="nc">&nbsp;            double interest = balance * monthlyRate;</b>
<b class="nc">&nbsp;            double principalComponent = emi - interest;</b>
<b class="nc">&nbsp;            balance -= principalComponent;</b>
&nbsp;
<b class="nc">&nbsp;            RepaymentSchedule schedule = new RepaymentSchedule();</b>
<b class="nc">&nbsp;            schedule.setLoan(loan);</b>
<b class="nc">&nbsp;            schedule.setMonth(m);</b>
<b class="nc">&nbsp;            schedule.setPrincipalAmount(principalComponent);</b>
<b class="nc">&nbsp;            schedule.setInterestAmount(interest);</b>
<b class="nc">&nbsp;            schedule.setBalanceRemaining(Math.max(balance, 0));</b>
<b class="nc">&nbsp;            schedule.setIsPaid(false);   // always initialize as unpaid</b>
&nbsp;
<b class="nc">&nbsp;            schedules.add(schedule);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return repaymentScheduleRepository.saveAll(schedules);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EmiPreviewResponse previewEmi(EmiPreviewRequest request) {
<b class="nc">&nbsp;        double emi = calculateEMI(request.getAmount(), request.getAnnualInterestRate(), request.getTenureMonths());</b>
<b class="nc">&nbsp;        double totalPayment = emi * request.getTenureMonths();</b>
<b class="nc">&nbsp;        double totalInterest = totalPayment - request.getAmount();</b>
&nbsp;
<b class="nc">&nbsp;        EmiPreviewResponse response = new EmiPreviewResponse();</b>
<b class="nc">&nbsp;        response.setEmi(emi);</b>
<b class="nc">&nbsp;        response.setTotalPayment(totalPayment);</b>
<b class="nc">&nbsp;        response.setTotalInterest(totalInterest);</b>
&nbsp;
<b class="nc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;RepaymentScheduleDTO&gt; getSchedule(Long loanId) {
<b class="nc">&nbsp;        return repaymentScheduleRepository.findByLoan_Id(loanId)</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .map(s -&gt; {</b>
<b class="nc">&nbsp;                    RepaymentScheduleDTO dto = new RepaymentScheduleDTO();</b>
<b class="nc">&nbsp;                    dto.setMonth(s.getMonth());</b>
<b class="nc">&nbsp;                    dto.setPrincipalAmount(s.getPrincipalAmount());</b>
<b class="nc">&nbsp;                    dto.setInterestAmount(s.getInterestAmount());</b>
<b class="nc">&nbsp;                    dto.setBalanceRemaining(s.getBalanceRemaining());</b>
<b class="nc">&nbsp;                    return dto;</b>
<b class="nc">&nbsp;                }).toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void pay(Long loanId, Long scheduleId) {
<b class="nc">&nbsp;        RepaymentSchedule schedule = repaymentScheduleRepository.findById(scheduleId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Schedule not found with id: &quot; + scheduleId));</b>
&nbsp;
<b class="nc">&nbsp;        if (!schedule.getLoan().getId().equals(loanId)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;This schedule does not belong to loan id: &quot; + loanId);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        schedule.setIsPaid(true);</b>
<b class="nc">&nbsp;        repaymentScheduleRepository.save(schedule);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-27 23:10</div>
</div>
</body>
</html>
